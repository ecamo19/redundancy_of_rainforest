---
title: 'Species list and traits available'
author: "Erick Calderon-Morales"
date: ''
due_date: ""
output:
  prettydoc::html_pretty:
    highlight: pygments
    theme: cayman
    toc: yes
    number_sections: no
    toc_depth: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,comment = "", fig.align = 'center',
					  fig.width = 11, fig.height = 7)
```

```{r knitr, include = FALSE}

# Save figures in specific place

knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.comments = TRUE,
                      
                      # Save a pdf_copy?
                      #dev            = c( "png", "pdf"),
                  
                      # Include code?
                      echo           = FALSE,
                      
                      error          = FALSE,
                      fig.align      = "center",
                      
                      # Path where figures are going to be store pdf single figures
                      fig.path       = paste0("./notebooks/figures_rawdataset", "/"),
                      fig.width      = 11,
                      fig.height     = 7,
                      message        = FALSE,
                      warning        = FALSE)
```



```{r libaries, message=FALSE, warning=FALSE, cache=FALSE}
library(janitor)
library(dplyr)
# For tables
library(reactable)
# For pivot function
library(tidyr)
# For reading html files
library(rvest)
# For pluck function
library(purrr)
# For read xls files
library(readxl)
# For working with names
library(stringr)
# For converting pdf to data
library(tabulizer) 
# For adding columns
library(tibble)
# For wood density estimation
library(BIOMASS)
```

```{r}
# Load species list that includes morpho species
sys.source("./codes/scripts/script_full_species_list.R", envir = knitr::knit_global())
```

```{r}
# Load TNRS species list 
tnrs_species_list <- read.csv("raw_data/tnrs_names_short.csv", header = T) %>% 
    clean_names()

# Load traits from BIEN
bien_traits <- read.csv("raw_data/data_from_bien_database_wet_forest.csv", 
                        header = T) %>% 
    clean_names()
```

# Full species list without morpho-species

```{r}
species_list <- 
    tnrs_species_list %>% 
        # Species' name manually changed
        mutate(accepted_species = if_else((name_submitted == "Billia colombiana"),"Putzeysia rosea",
                                          if_else(name_submitted == "Hyeronima oblonga", "Stilaginella oblonga",accepted_species))) %>% 
        select(name_submitted,taxonomic_status,accepted_species) %>% 
        arrange(name_submitted) %>% 
        
        # In this list Brosimum panamense is treat as a different species and is 
        # not. Remove
        filter(!name_submitted == "Brosimum panamense")    

reactable(species_list)
```

# Reproductive traits

##  Traits from Salgado

```{r}
# Load Original file
raw_salgado_traits <- read_xls("./raw_data/response_traits/original_raw_data_files/Costa Rica rainforest trees 2 Salgado_original.xls") %>% 
    clean_names()
```

### Species with traits in Salgado dataset

```{r}
data_salgado_traits <- 
    raw_salgado_traits %>%
        select(-c(familia, autoridad)) %>% 
        unite("name_submitted", genero, especie, sep = " ", remove = F) %>% 
        
        # Species with traits in Salgado dataset
        inner_join(species_list, . , by = "name_submitted") %>% 
        select(-c(estrato,tasacrecimiento,rep_vegetativa)) %>% 
        
        # Rename columns
        rename(dispersal_syndrome = "diseminacion",
               sexual_system = "sist_sexual",
               pollination_syndrome = "polinizacion") %>%
        
        # Remove reference numbers, parentheses and comas
        mutate(across(where(is.character), str_replace_all, pattern = "[:digit:]|[(,)]",
                      replacement = ""))   %>% 
        
        # Rename levels in dispersion column
        mutate(dispersal_syndrome = case_when(
            # Wind
            dispersal_syndrome == "W"  ~ "dwin",
            # Hidrocoria
            dispersal_syndrome == "H"  ~ "dhid",
            # Convert Flying animals Non-flying animals to just animals
            dispersal_syndrome == "V" | dispersal_syndrome == "NV"  ~ "dani",
            # Autocoria
            dispersal_syndrome == "A" ~ "daut",
            str_detect(dispersal_syndrome, "-")  ~ "dvar",
            TRUE ~ dispersal_syndrome)) %>%
        
        # Rename levels in sexual_system column
        mutate(sexual_system = case_when(
            # Dioecious
            sexual_system == "D"  ~ "ssdio",
            # Monoecious
            sexual_system == "M"  ~ "ssmon",
            # Hermaphroditic
            sexual_system == "H" ~ "ssher",
            TRUE ~ sexual_system)) %>% 
        
        # Rename levels in pollination column
        mutate(pollination_syndrome = case_when(
            # Wind
            pollination_syndrome == "W"  ~ "pwin",
            # Insects
            pollination_syndrome == "I"  ~ "pins",
            # Birds
            pollination_syndrome == "A" ~ "pbir",
            # Mammals
            pollination_syndrome == "MA" ~ "pmam",
            # Various 
            str_detect(pollination_syndrome, "-")  ~ "pvar",
            TRUE ~ pollination_syndrome)) %>% 
        
        # Add author
        add_column(source = "bsalgado dataset")

```

```{r}
reactable(data_salgado_traits)
```



```{r}
### Species with no traits in Salgado dataset
species_with_no_traits_58 <- 
    raw_salgado_traits %>% 
        select(-c(familia, autoridad)) %>% 
        unite("name_submitted", genero, especie, sep = " ") %>% 
    
        # Species with NO traits in Salgado dataset
        anti_join(species_list, . , by = "name_submitted")
```

## Traits from Chazdon et al

### Species with traits in Chazdon et al

```{r}
# Load Original file
raw_chazdon_traits <- 
    read_html("./raw_data/response_traits/original_raw_data_files/reproductive traits for 366 species in 10 wet tropical forests_chazdon2003.html") %>% 
        html_table(header = T) %>% 
        purrr::pluck(1)  %>% 
        clean_names() 
```


```{r}
data_chazdon_traits <- 
    raw_chazdon_traits %>% 
        
        # Remove column
        select(-c(life_form, family)) %>% 
        
        # Remove \n\t and dots  
        mutate(across(2:4, str_replace_all, pattern = "[\n\t]|[:digit:]|[(,)]|[.]|[ ]",
                      replacement = "")) %>% 
        
        # Step for removing authority
        separate(species, c("genero", "especie")) %>% 
        
         # Rename levels in sexual_system column
        mutate(sexual_system = case_when(
            # Dioecious
            sexual_system == "D"  ~ "ssdio",
            # Monoecious
            sexual_system == "M"  ~ "ssmon",
            # Hermaphroditic
            sexual_system == "H" ~ "ssher",
            TRUE ~ sexual_system)) %>% 
        
        # Rename levels in pollination column
        mutate(pollination_syndrome = case_when(
            # Wind
            pollination_syndrome == "W"  ~ "pwin",
            # Insects
            pollination_syndrome == "I"  ~ "pins",
            # Birds
            pollination_syndrome == "HB" ~ "pbir",
            # Mammals
            pollination_syndrome == "MA" ~ "pmam",
            TRUE ~ pollination_syndrome)) %>% 
        
        # Rename levels in dispersion column
        mutate(dispersal_syndrome = case_when(
            # Wind
            dispersal_syndrome == "W"  ~ "dwin",
            # Hidrocoria
            dispersal_syndrome == "H"  ~ "dhid",
            # Animals
            dispersal_syndrome == "A" ~ "dani",
            # Autocoria
            dispersal_syndrome == "E" ~ "daut",
            str_detect(dispersal_syndrome, "-")  ~ "dvar",
            TRUE ~ dispersal_syndrome)) %>% 
    
        arrange(genero) %>% 
        
        # Join columns for get full name use TNRS accepted species
        unite("species", genero, especie, sep = " ", remove = F) %>% 
        
        # Rename species names that are wrong
        mutate(species = case_when(
            species == "Cespedesia spathulata"  ~ "Cespedesia macrophylla",
            species == "Cojoba catenatum"  ~ "Cojoba catenata",
            species == "Inga thiboudiana" ~ "Inga thibaudiana",
            TRUE ~ species)) %>% 
        
        # Species with traits in Chazdon et al
        inner_join(., species_with_no_traits_58 , by = c("species" = "name_submitted" )) %>% 
            
        add_column(source = "https://doi.org/10.6084/m9.figshare.c.3309012.v1")

reactable(data_chazdon_traits)   
```


```{r}
### Species with no traits
species_with_no_traits_46 <-
     data_chazdon_traits %>% 
         anti_join(species_with_no_traits_58, . , by = c( "name_submitted" = "species")) %>% 
         arrange(name_submitted)
```

## Species identified by Nelson Zamora

```{r}
raw_zamora_traits <- 
    read_xlsx("./raw_data/response_traits/original_raw_data_files/species_identified_NZamora_original.xlsx") %>% 
    clean_names() %>% 
    select(-familia)
```


### Species with traits
```{r}
data_zamora_traits <- 
    raw_zamora_traits %>%
    
        # Join columns for get full name
        unite("name_submitted", genero, especie, sep = " ", remove = F) %>%
        
        select(-tipo_de_dispersion_original) %>% 
    
        # Rename columns
        rename(dispersal_syndrome = "tipo_de_dispersion",
               sexual_system = "sistema_sexual",
               pollination_syndrome = "agente_polinizador")  %>% 
    
        # Rename levels in sexual_system column
        mutate(sexual_system = case_when(
            # Dioecious
            sexual_system == "D"  ~ "ssdio",
            # Monoecious
            sexual_system == "M"  ~ "ssmon",
            # Hermaphroditic
            str_detect(sexual_system, pattern = "[bisexual]|[H]") ~ "ssher",
            TRUE ~ sexual_system)) %>% 
    
        # Rename levels in pollination column
        mutate(pollination_syndrome = case_when(
            # Wind
            pollination_syndrome == "W"  ~ "pwin",
            # Mammals
            str_detect(pollination_syndrome, pattern = "murc") ~ "pmam",
            # Insects
            str_detect(pollination_syndrome, pattern = "[bee]|[insec]|[I]")  ~ "pins",
            # Birds
            pollination_syndrome == "HB" ~ "pbir",
            TRUE ~ pollination_syndrome))  %>% 
    
        # Rename levels in dispersion column
        mutate(dispersal_syndrome = case_when(
            # Wind
            dispersal_syndrome == "W"  ~ "dwin",
            # Hidrocoria
            dispersal_syndrome == "H"  ~ "dhid",
            # Animals
            dispersal_syndrome == "A" | dispersal_syndrome == "NW" | dispersal_syndrome == "AN"  ~ "dani", 
            # Autocoria
            dispersal_syndrome == "E" ~ "daut",
            str_detect(dispersal_syndrome, ",")  ~ "dvar",
            TRUE ~ dispersal_syndrome)) %>%
    
        arrange(name_submitted) %>%  
        inner_join(. ,species_with_no_traits_46, by = "name_submitted")

#Bisexual: each flower of each individual has both male and female structures
# hermaphroditism, the condition of having both male and female reproductive organs.
# bisexual == herma


reactable(data_zamora_traits)
```


```{r}
### Species with no traits
species_with_no_traits_13 <- 
    data_zamora_traits %>% 
    
    # Join columns for get full name
    unite("name_submitted", genero, especie, sep = " ") %>% 
    
    # Species with traits identyfied by Nelson Zamora
    anti_join(species_with_no_traits_46, . , by = "name_submitted")
```

## Species identified by Orlando Vargas

```{r cache = TRUE}
raw_data_orlando <- extract_tables("./raw_data/response_traits/original_raw_data_files/lista_arboles_sindromes_OVR05.pdf", 
                                   
                                   # Read this pages
                                   pages = c(1:14), 
                                   method = "lattice")
```

### Species with traits
```{r}
data_orlando_traits <- 
    map_dfr(raw_data_orlando, as_tibble) %>% 
        row_to_names(row_number = 1) %>% 
        clean_names()   %>% 
        
        # Column poli-viento not included
        # only three species Weinmannia pinnata,Eschweilera costaricensis 
        # Sorocea pubivena poli by wind
        rename( dis_mamifero = "x",
                dis_aves     = "x_2",
                dis_viento   = "x_3",
                dis_agua     = "x_4",
                gravedad_explosion = "x_5",
                comentarios_1 = "x_6",
                poli_aves = "x_7",
                poli_mamiferos = "x_8",
                poli_insectos = "x_9",
                poli_viento = "x_10",
                comentarios_2 = "x_11",
                sexual_system = "sistema_sexual_bisexual_monoica_dioica_unisexual_poligama_poligama_dioica") %>% 
        select(-c(autores, nombre_comun, comentarios_1,comentarios_2))  %>% 
        
        unite("name", genero, especie, sep = " ", remove = F) %>% 
        # Rename species names that are wrong
        mutate(name = case_when(
            name == "Tabebuia chrysantha??"  ~ "Tabebuia chrysantha",
            TRUE ~ name)) %>% 
        
        # Select the species that I need
        inner_join(species_with_no_traits_13 ,., by = c("name_submitted" = "name" )) %>% 
    
        # Rename levels in dispersal columns  
        mutate(
            # Animals
            dis_mamifero = case_when(
                dis_mamifero == 1 ~ "dani",
                TRUE ~ dis_mamifero),
        
            dis_aves = case_when(
                dis_aves == 1 ~ "dani",
                TRUE ~ dis_aves),
            
            # Wind
            dis_viento = case_when(
                dis_viento == 1 ~ "dwin",
                TRUE ~ dis_viento),
            
            # Hidrocoria
            dis_agua = case_when(
                dis_agua == 1 ~ "dhid",
                TRUE ~ dis_agua),
            
            # Autocoria
            gravedad_explosion = case_when(
                gravedad_explosion == 1 ~ "daut",
                TRUE ~ gravedad_explosion)) %>% 
            
            # Rename levels in dispersal columns
            mutate(
              # Birds
              poli_aves = case_when(
                  poli_aves == 1 ~ "pbir",
                  TRUE ~ poli_aves),
              
              # Mammals
              poli_mamiferos = case_when(
                  poli_mamiferos == 1 ~ "pmam",
                  TRUE ~ poli_mamiferos),
              
              # Insects
              poli_insectos = case_when(
                  poli_insectos == 1 ~ "pins",
                  TRUE ~ poli_insectos),
              
              # Wind
              poli_viento = case_when(
                  poli_viento == 1 ~ "pwin",
                  TRUE ~ poli_viento)
              ) %>%           
        
        # Create new colums
        unite(dispersal_syndrome ,7:11, sep = "_") %>%  
        unite(pollination_syndrome, 8:11, sep = "_") %>% 
    
        # Delete special characters
        mutate(across(6:ncol(.), str_replace_all, pattern = "__|[*]|[?]",replacement = "")) %>%  
        
        # Add category dvar for species with more than 1     
        mutate(dispersal_syndrome = case_when(
            str_detect(dispersal_syndrome, "_")  ~ "dvar",
            TRUE ~ dispersal_syndrome)) %>% 
        
        # Remove underscore from pins
         mutate(across(8, str_replace_all, pattern = "_",replacement = "")) %>% 

    
        # Rename sexual system    
        mutate(sexual_system = case_when(
            sexual_system == "B"  ~ "ssher")) %>% 
        
        add_column(source = "https://sura.ots.ac.cr/florula4/docs/lista_arboles_sindromes_OVR05.pdf")  

reactable(data_orlando_traits)
```

## Species with no traits
```{r}
reactable(anti_join(species_with_no_traits_13,data_orlando_traits , by = "name_submitted"))
```
[Cecropia peltata info](https://www.srs.fs.usda.gov/pubs/misc/ag_654/volume_2/cecropia/peltata.htm)


# Wood density
```{r}
# Join the names from TRNS with the morphospecies
wood_density_sp_list <- 
    data_species_full_list %>%
        
        # Get morphospecies
        filter((str_detect(especie, "^sp") & (str_length(especie) <= 4))) %>%
        
        # Set first letter to uppercase
        mutate(genero = str_to_title(genero)) %>% 
        
        # Create column for joining the datasets
        unite(accepted_species, genero, especie, sep = " ") %>%
        
        # Join    
        full_join(.,species_list,by = "accepted_species" ) %>%   
        
        # Get only the accepted_species
        select(accepted_species) %>% 
    
        # Create columns for the function getWoodDensity
        separate(accepted_species, c("genus", "specie"), sep = " ", remove = F) %>% 
        
        # This step is done for calculating wood density at the genus level for
        # the morpho-species
        mutate(specie = case_when(
            str_detect(specie, pattern = "^sp") ~ "NA",
            TRUE ~ specie)) 
        
```

## Get wood density values
```{r cache = TRUE}
# https://search.r-project.org/CRAN/refmans/BIOMASS/html/getWoodDensity.html

wood_density <- 
    getWoodDensity(
          genus = wood_density_sp_list$genus,
          species = wood_density_sp_list$specie,
          region = c("CentralAmericaTrop", "SouthAmericaTrop"))
```

```{r}
data_wood_density <- 
    wood_density %>% 
        group_by(genus, species) %>% 
        
        # Name morpho-species in a sequential manner
        mutate(species = if_else(species == "NA",paste0("sp",row_number()),species)) %>% 
        
        # Arrange columns and clean names
        select(1:3,levelWD, everything()) %>% 
        clean_names() %>% 
        arrange(genus)
    
```

```{r}
reactable(data_wood_density)
```














